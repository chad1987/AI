# 网页版云手机应用开发规划

## 1. 目标与范围定义（Phase 0）
- **产品目标**：用户在浏览器中远程操作云端 Android 实例，支持低延迟画面、触控/键鼠映射、应用安装与基本设备管理。
- **首发场景（MVP）**：
  - 单设备实时操控（画面 + 输入）
  - 账号登录与设备列表
  - 基础运维能力（开机/关机/重启）
  - 会话审计日志（操作开始/结束、设备状态）
- **非目标（MVP 不做）**：多租户计费闭环、复杂群控自动化、iOS 虚拟化支持。

## 2. 总体架构设计（Phase 1）

### 2.1 前端（Web 控制台）
- 技术建议：`React + TypeScript + Vite`。
- 关键模块：
  - 登录与权限（JWT/OIDC）
  - 设备列表与状态面板
  - 远程操控页（视频流播放器 + 输入事件采集层）
  - 文件上传（APK、媒体文件）
- 实时通道：优先 `WebRTC`（媒体 + DataChannel），WebSocket 作为信令与控制补充。

### 2.2 后端控制平面
- 技术建议：`Go` 或 `Node.js (NestJS)`。
- 微服务拆分：
  - API Gateway（鉴权、限流）
  - Device Orchestrator（设备生命周期）
  - Session Service（会话创建、续期、回收）
  - Signaling Service（WebRTC 建链）
  - Audit & Metrics（日志和指标）
- 数据层：
  - `PostgreSQL`（用户、设备、会话元数据）
  - `Redis`（会话状态缓存、分布式锁）
  - `S3/OSS`（录屏与日志归档，可选）

### 2.3 云手机运行平面
- Android 实例建议：容器化 Android（如 AOSP/emulator 容器）或虚拟机池。
- 节点代理（Agent）：
  - 拉起/销毁实例
  - 采集视频流并推送至 WebRTC SFU/媒体网关
  - 注入输入事件（触摸、键盘、系统按键）
- 编排层：`Kubernetes`（节点池管理、弹性扩容、故障迁移）。

## 3. 核心技术路线

### 3.1 低延迟音视频链路
- 首选 H.264/H.265 + WebRTC。
- 目标指标（MVP）：
  - 端到端延迟：< 300ms（内网）
  - 首帧时间：< 2s
  - 会话稳定性：30 分钟不掉线率 > 99%
- 自适应策略：分辨率、码率、帧率动态降级。

### 3.2 输入控制与映射
- 浏览器事件（鼠标、触屏、键盘）映射到 Android Input。
- 支持：单点触控、滑动、多按键。
- 安全限制：禁用高危系统按键组合或做白名单。

### 3.3 安全与合规
- 鉴权：OIDC/JWT + 短时会话 token。
- 传输加密：全链路 TLS，WebRTC DTLS/SRTP。
- 审计：操作日志、IP、会话录像（按合规要求）。
- 隔离：设备实例网络隔离、文件系统隔离、最小权限运行。

## 4. 里程碑计划（建议 16 周）
- **M1（第 1-2 周）**：需求冻结、原型图、技术选型 PoC。
- **M2（第 3-6 周）**：
  - 完成账号体系、设备列表、会话创建 API
  - 打通 WebRTC 基础链路（单设备）
- **M3（第 7-10 周）**：
  - 输入事件全链路可用
  - 设备生命周期管理（开关机、重置）
  - 基础监控与日志
- **M4（第 11-13 周）**：
  - 灰度发布、压测与稳定性优化
  - 权限模型与审计完善
- **M5（第 14-16 周）**：
  - Beta 上线
  - SLA 基线、运维手册、应急预案

## 5. 团队配置建议
- 前端工程师 2 人（控制台 + 播放交互）
- 后端工程师 2-3 人（控制平面 + 实时服务）
- 音视频/RTC 工程师 1-2 人
- Android/虚拟化工程师 1-2 人
- QA 1-2 人，SRE/DevOps 1 人

## 6. 测试与质量保障
- 功能测试：会话创建、控制、断线重连、文件传输。
- 性能测试：并发会话数、启动时延、长稳测试（8h/24h）。
- 异常演练：节点故障、网络抖动、信令中断、实例崩溃。
- 质量门禁：
  - 单测覆盖率（核心模块）> 70%
  - P0 缺陷清零后发布

## 7. 运维与成本控制
- 成本模型：按在线设备时长 + 峰值并发估算。
- 自动伸缩：基于 CPU/GPU 利用率、会话队列长度。
- 可观测性：Prometheus + Grafana + Loki/ELK。
- 告警：会话失败率、黑屏率、节点资源水位。

## 8. MVP 之后的演进方向
- 群控与批量自动化（脚本编排）
- 录制回放与问题复现
- 多地域调度与就近接入
- 商业化能力（计费、套餐、配额）

## 9. 风险清单与缓解
- **高并发下延迟上升**：提前做压测与容量规划，部署 SFU 集群。
- **设备兼容性问题**：定义支持矩阵，分层灰度。
- **安全事件风险**：加强审计、最小权限、定期渗透测试。
- **成本失控**：设置资源配额和自动回收策略。
